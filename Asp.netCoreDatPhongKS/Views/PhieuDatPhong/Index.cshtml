@model IEnumerable<Asp.netCoreDatPhongKS.Models.PhieuDatPhong>
@{
    ViewData["Title"] = "Danh sách phiếu đặt phòng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-4">
    <h2>Danh sách phiếu đặt phòng</h2>
    <a href="@Url.Action("Create", "PhieuDatPhong")" class="btn btn-primary mb-3">Tạo phiếu mới</a>
    <table class="table">
        <thead>
            <tr>
                <th>Mã phiếu</th>
                <th>Khách hàng</th>
                <th>Phòng</th>
                <th>Loại phòng</th>
                <th>Ngày nhận</th>
                <th>Ngày trả</th>
                <th>Tổng tiền</th>
                <th>Tiền cọc</th>
                <th>Số tiền đã thanh toán</th>
                <th>Trạng thái</th>
                <th>Tình trạng sử dụng</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.MaPhieu</td>
                    <td>@(item.KhachHang?.HoTen ?? "Không xác định")</td>
                    <td>@item.ChiTietPhieuPhongs.FirstOrDefault()?.Phong?.SoPhong</td>
                    <td>@item.ChiTietPhieuPhongs.FirstOrDefault()?.Phong?.LoaiPhong?.TenLoai</td>
                    <td>@item.NgayNhan?.ToString("dd/MM/yyyy")</td>
                    <td>@item.NgayTra?.ToString("dd/MM/yyyy")</td>
                    <td>@item.TongTien?.ToString("N0") VNĐ</td>
                    <td>@item.SoTienCoc?.ToString("N0") VNĐ</td>
                    <td>@item.SoTienDaThanhToan?.ToString("N0") VNĐ</td>
                    <td>@item.TrangThai</td>
                    <td>@item.TinhTrangSuDung</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="showPhieuDatPhongDetails(@item.PhieuDatPhongId)">Chi tiết</button>
                        @if (!(item.TinhTrangSuDung == "Đã check-out" || item.TrangThai == "Đã thanh toán"))
                        {
                            <a asp-action="Edit" asp-route-id="@item.PhieuDatPhongId" class="btn btn-warning btn-sm">Sửa</a>
                        }  <a asp-action="Delete" asp-route-id="@item.PhieuDatPhongId" class="btn btn-danger btn-sm">Xóa</a>
                        <a asp-action="PrintPhieuDatPhong" asp-route-id="@item.PhieuDatPhongId" class="btn btn-success btn-sm" target="_blank">In</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="phieuDatPhongDetailsModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết phiếu đặt phòng</h5>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div id="phieuDatPhongDetailsContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    @if (TempData["Success"] != null)
    {
        @:toastr.success('@TempData["Success"]');
    }
    @if (TempData["Error"] != null)
    {
        @:toastr.error('@TempData["Error"]');
    }

    function showPhieuDatPhongDetails(phieuDatPhongId) {
        fetch(`/PhieuDatPhong/GetPhieuDatPhongDetails?phieuDatPhongId=${phieuDatPhongId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const phieu = data.phieu;
                    const content = `
                        <h4>Phiếu đặt phòng: ${phieu.maPhieu}</h4>
                        <p><strong>Khách hàng:</strong> ${phieu.khachHang.hoTen} (${phieu.khachHang.email})</p>
                        <p><strong>Phòng:</strong> ${phieu.chiTiet.soPhong} (${phieu.chiTiet.loaiPhong})</p>
                        <p><strong>Giá/đêm:</strong> ${phieu.chiTiet.donGia.toLocaleString()} VNĐ</p>
                        <p><strong>Ngày nhận:</strong> ${new Date(phieu.ngayNhan).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Ngày trả:</strong> ${new Date(phieu.ngayTra).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Số ngày:</strong> ${phieu.soNgay}</p>
                        <p><strong>Tổng tiền:</strong> ${phieu.tongTien.toLocaleString()} VNĐ</p>
                        <p><strong>Tiền cọc:</strong> ${phieu.soTienCoc.toLocaleString()} VNĐ</p>
                        <p><strong>Tiền đã thanh toán:</strong> ${phieu.soTienDaThanhToan.toLocaleString()} VNĐ</p>
                        <p><strong>Trạng thái:</strong> ${phieu.trangThai}</p>
                        <p><strong>Tình trạng sử dụng:</strong> ${phieu.tinhTrangSuDung}</p>
                    `;
                    document.getElementById('phieuDatPhongDetailsContent').innerHTML = content;
                    $('#phieuDatPhongDetailsModal').modal('show');
                } else {
                    toastr.error(data.message || 'Không thể tải chi tiết phiếu đặt phòng.');
                }
            })
            .catch(error => toastr.error('Có lỗi xảy ra: ' + error.message));
    }
</script>