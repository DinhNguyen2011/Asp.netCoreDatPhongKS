@model IEnumerable<Asp.netCoreDatPhongKS.Models.PhieuDatPhong>
@{
    ViewData["Title"] = "Danh sách phiếu đặt phòng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="~/css/PhieuDatPhongAdmin.css" rel="stylesheet" />
<div class="container mt-4">
    <h2>Danh sách phiếu đặt phòng</h2>
    <div class="mb-3">
        <a href="@Url.Action("Create", "PhieuDatPhong")" class="btn btn-primary">Tạo phiếu mới</a>
        <a href="@Url.Action("hienThiphieuHuy", "PhieuDatPhong")" class="btn btn-danger">Xem phiếu hủy</a>
    </div>
    <div class="rule-item" style="color:red !important;">
        <div class="rule-title"> *Chú ý: Quy định về số lượng khách trong phòng</div>
        <div class="rule-content">Trong trường hợp khách hàng đi 5 người nhưng khách sạn chỉ còn phòng dành cho 4 người(hay các trường hợp khác), khách sạn sẽ thu thêm phụ phí theo quy định hiện hành là 10% theo giá của phòng.</div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Mã phiếu</th>
                    <th>Khách hàng</th>
                    <th>Phòng</th>
                    <th>Loại phòng</th>
                    <th>Ngày nhận</th>
                    <th>Ngày trả</th>
                    <th>Tổng tiền</th>
                    <th>Tiền cọc</th>
                    <th>Đã thanh toán</th>
                    <th>Trạng thái</th>
                    <th>Tình trạng</th>
                    <th class="action-column">Thao tác phiếu đặt phòng</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.MaPhieu</td>
                        <td>@(item.KhachHang?.HoTen ?? "Không xác định")</td>
                        <td>@(item.ChiTietPhieuPhongs.FirstOrDefault()?.Phong?.SoPhong ?? "N/A")</td>
                        <td>@(item.ChiTietPhieuPhongs.FirstOrDefault()?.Phong?.LoaiPhong?.TenLoai ?? "N/A")</td>
                        <td>@(item.NgayNhan?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                        <td>@(item.NgayTra?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                        <td>@(item.TongTien?.ToString("N0") ?? "0") VNĐ</td>
                        <td>@(item.SoTienCoc?.ToString("N0") ?? "0") VNĐ</td>
                        <td>@(item.SoTienDaThanhToan?.ToString("N0") ?? "0") VNĐ</td>
                        <td>@item.TrangThai</td>
                        <td>@item.TinhTrangSuDung</td>
                        <td class="action-column">
                            <div class="btn-group" role="group">
                                <button class="btn btn-info btn-sm" onclick="showPhieuDatPhongDetails(@item.PhieuDatPhongId)">Chi tiết</button>
                                @if (item.TinhTrangSuDung != "Đã check-out")
                                {
                                    <a asp-action="Edit" asp-route-id="@item.PhieuDatPhongId" class="btn btn-warning btn-sm">Sửa</a>
                                }
                                <a asp-action="Delete" asp-route-id="@item.PhieuDatPhongId" class="btn btn-danger btn-sm">Xóa</a>
                                <a asp-action="PrintPhieuDatPhong" asp-route-id="@item.PhieuDatPhongId" class="btn btn-success btn-sm" target="_blank">In</a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div id="phieuDatPhongDetailsModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết phiếu đặt phòng</h5>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div id="phieuDatPhongDetailsContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    @if (TempData["Success"] != null)
    {
        @:toastr.success('@TempData["Success"]');
    }
    @if (TempData["Error"] != null)
    {
        @:toastr.error('@TempData["Error"]');
    }

    function showPhieuDatPhongDetails(phieuDatPhongId) {
        fetch(`/PhieuDatPhong/GetPhieuDatPhongDetails?phieuDatPhongId=${phieuDatPhongId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const phieu = data.phieu;
                    const content = `
                        <h4>Phiếu đặt phòng: ${phieu.maPhieu}</h4>
                        <p><strong>Khách hàng:</strong> ${phieu.khachHang.hoTen} (${phieu.khachHang.email})</p>
                        <p><strong>Phòng:</strong> ${phieu.chiTiet.soPhong} (${phieu.chiTiet.loaiPhong})</p>
                        <p><strong>Giá/đêm:</strong> ${phieu.chiTiet.donGia.toLocaleString()} VNĐ</p>
                        <p><strong>Ngày nhận:</strong> ${new Date(phieu.ngayNhan).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Ngày trả:</strong> ${new Date(phieu.ngayTra).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Số ngày:</strong> ${phieu.soNgay}</p>
                        <p><strong>Tổng tiền:</strong> ${phieu.tongTien.toLocaleString()} VNĐ</p>
                        <p><strong>Tiền cọc:</strong> ${phieu.soTienCoc.toLocaleString()} VNĐ</p>
                        <p><strong>Tiền đã thanh toán:</strong> ${phieu.soTienDaThanhToan.toLocaleString()} VNĐ</p>
                        <p><strong>Trạng thái:</strong> ${phieu.trangThai}</p>
                        <p><strong>Tình trạng sử dụng:</strong> ${phieu.tinhTrangSuDung}</p>
                        <p><strong>VNPay:</strong> ${phieu.idvnpay}</p>
                        <p><strong>MoMo:</strong> ${phieu.idmomo}</p>
                    `;
                    document.getElementById('phieuDatPhongDetailsContent').innerHTML = content;
                    $('#phieuDatPhongDetailsModal').modal('show');
                } else {
                    toastr.error(data.message || 'Không thể tải chi tiết phiếu đặt phòng.');
                }
            })
            .catch(error => toastr.error('Có lỗi xảy ra: ' + error.message));
    }
</script>