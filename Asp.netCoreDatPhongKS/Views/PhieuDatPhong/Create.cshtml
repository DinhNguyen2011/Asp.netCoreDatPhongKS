@model Asp.netCoreDatPhongKS.Models.PhieuDatPhong
@{
    ViewData["Title"] = "Tạo phiếu đặt phòng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="~/css/PhieuDatPhongAdmin.css" rel="stylesheet" />
<div class="container mt-4">
    <h2>Tạo phiếu đặt phòng</h2>
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    <form asp-action="Create" asp-controller="PhieuDatPhong" method="post" id="phieuDatPhongForm">
        <div class="form-group">
            <label>Khách hàng <span class="text-danger">*</span></label>
            <div class="d-flex">
                <select asp-for="KhachHangId" class="form-control" id="khachHangSelect" required>
                    <option value="">Chọn khách hàng</option>
                    @foreach (var khachHang in ViewBag.KhachHangs ?? new List<Asp.netCoreDatPhongKS.Models.KhachHang>())
                    {
                        <option value="@khachHang.KhachHangId">@khachHang.HoTen (@khachHang.Email)</option>
                    }
                </select>
                <button type="button" class="btn btn-primary ml-2" onclick="showAddKhachHangForm()">Thêm khách hàng mới</button>
            </div>
            <span asp-validation-for="KhachHangId" class="text-danger"></span>
        </div>

        <div id="addKhachHangForm" style="display:none;" class="mt-3">
            <h4>Thêm khách hàng mới</h4>
            <div class="form-group">
                <label>Họ tên <span class="text-danger">*</span></label>
                <input type="text" id="newKhachHangHoTen" class="form-control" />
            </div>
            <div class="form-group">
                <label>Email <span class="text-danger">*</span></label>
                <input type="email" id="newKhachHangEmail" class="form-control" />
            </div>
            <div class="form-group">
                <label>Số điện thoại <span class="text-danger">*</span></label>
                <input type="text" id="newKhachHangSoDienThoai" class="form-control" />
            </div>
            <div class="form-group">
                <label>Địa chỉ <span class="text-danger">*</span></label>
                <input type="text" id="newKhachHangDiaChi" class="form-control" />
            </div>
            <div class="form-group">
                <label>CCCD <span class="text-danger">*</span></label>
                <input type="text" id="newKhachHangCccd" class="form-control" />
            </div>
            <div class="form-group">
                <label>Ghi chú</label>
                <textarea id="newKhachHangGhiChu" class="form-control"></textarea>
            </div>
            <button type="button" class="btn btn-success" onclick="addKhachHang()">Lưu khách hàng</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddKhachHangForm()">Hủy</button>
        </div>

        <div class="form-group">
            <label>Ngày nhận phòng <span class="text-danger">*</span></label>
            <input asp-for="NgayNhan" type="date" class="form-control" required id="ngayNhan" />
            <span asp-validation-for="NgayNhan" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label>Ngày trả phòng <span class="text-danger">*</span></label>
            <input asp-for="NgayTra" type="date" class="form-control" required id="ngayTra" />
            <span asp-validation-for="NgayTra" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label>Số lượng khách/phòng</label>
            <input type="number" id="soLuongKhach" class="form-control" min="1" />
        </div>
        <div class="form-group">
            <label>Khuyến mãi</label>
            <select name="khuyenMaiId" class="form-control" id="khuyenMaiSelect" onchange="calculateTotal()">
                <option value="">Không áp dụng khuyến mãi</option>
                @foreach (var km in ViewBag.KhuyenMaiOptions ?? new List<SelectListItem>())
                {
                    <option value="@km.Value" data-phantramgiam="@(km.Text.Contains("(") ? km.Text.Substring(km.Text.IndexOf("(") + 1, km.Text.IndexOf("%") - km.Text.IndexOf("(") - 1) : "0")">@km.Text</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Tiền cọc <span class="text-danger">*</span></label>
            <input type="number" name="soTienCoc" class="form-control" min="0" step="0.01" required />
        </div>
        <div class="form-group">
            <label>Số tiền đã thanh toán (nếu có)</label>
            <input type="number" name="soTienDaThanhToan" class="form-control" min="0" step="0.01" />
        </div>
        <div class="form-group">
            <label>Tổng tiền (sau khuyến mãi)</label>
            <input type="text" id="tongTien" class="form-control" readonly />
        </div>
        <div class="form-group">
            <label>Trạng thái <span class="text-danger">*</span></label>
            <select name="trangThai" class="form-control" required>
                <option value="">Chọn trạng thái</option>
                @foreach (var item in ViewBag.TrangThaiOptions)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Tình trạng sử dụng <span class="text-danger">*</span></label>
            <select name="tinhTrangSuDung" class="form-control" required>
                <option value="">Chọn tình trạng</option>
                @foreach (var item in ViewBag.TinhTrangSuDungOptions)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Chọn phòng <span class="text-danger">*</span></label>
            <select name="phongIds" multiple class="form-control" required id="phongSelect" onchange="calculateTotal()">
                @foreach (var phong in ViewBag.Phongs ?? new List<Asp.netCoreDatPhongKS.Models.Phong>())
                {
                    <option value="@phong.PhongId"
                            data-hinhanh="@(phong.HinhAnh != null ? phong.HinhAnh.Replace("~/images/", "/images/") : "/images/no-image.jpg")"
                            data-hinhanh1="@(phong.HinhAnh1 != null ? phong.HinhAnh1.Replace("~/images/", "/images/") : "")"
                            data-hinhanh2="@(phong.HinhAnh2 != null ? phong.HinhAnh2.Replace("~/images/", "/images/") : "")"
                            data-hinhanh3="@(phong.HinhAnh3 != null ? phong.HinhAnh3.Replace("~/images/", "/images/") : "")"
                            data-sophong="@phong.SoPhong"
                            data-loaiPhong="@(phong.LoaiPhong?.TenLoai ?? "Không xác định")"
                            data-soluongkhach="@phong.SoLuongKhach"
                            data-dongia="@phong.GiaPhong1Dem">
                        Phòng @phong.SoPhong - @(phong.LoaiPhong?.TenLoai ?? "Không") - Giá: @phong.GiaPhong1Dem?.ToString("N0") VNĐ/ngày - @phong.SoLuongKhach khách
                    </option>
                }
            </select>
            <button type="button" class="btn btn-info mt-2" onclick="filterAvailableRooms()">Lọc phòng khả dụng</button>
        </div>
        <div id="roomPreview" class="mt-3 row"></div>
        <button type="submit" class="btn btn-success mt-4">Tạo phiếu</button>
        <a href="@Url.Action("Index", "PhieuDatPhong")" class="btn btn-secondary mt-4">Quay lại</a>
    </form>
</div>

<style>
    #roomPreview .card {
        margin-bottom: 15px;
        transition: transform 0.2s;
        position: relative;
    }

        #roomPreview .card:hover {
            transform: scale(1.02);
        }

    #roomPreview .card-img-top {
        height: 150px;
        object-fit: cover;
    }

    #roomPreview .carousel-inner img {
        height: 150px;
        object-fit: cover;
    }

    #roomPreview .remove-room {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        z-index: 3;
    }

    #roomPreview .card-text.description {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #roomPreview .icon {
        margin-right: 5px;
    }
</style>

<script>
    const FALLBACK_IMAGE = '/images/no-image.jpg';

    function showAddKhachHangForm() { document.getElementById('addKhachHangForm').style.display = 'block'; }
    function hideAddKhachHangForm() { document.getElementById('addKhachHangForm').style.display = 'none'; }

    function addKhachHang() {
        var khachHang = {
            HoTen: document.getElementById('newKhachHangHoTen').value,
            Email: document.getElementById('newKhachHangEmail').value,
            SoDienThoai: document.getElementById('newKhachHangSoDienThoai').value,
            DiaChi: document.getElementById('newKhachHangDiaChi').value,
            Cccd: document.getElementById('newKhachHangCccd').value,
            GhiChu: document.getElementById('newKhachHangGhiChu').value
        };

        if (!khachHang.HoTen || !khachHang.Email || !khachHang.SoDienThoai || !khachHang.DiaChi || !khachHang.Cccd) {
            toastr.error('Vui lòng nhập đầy đủ thông tin.');
            return;
        }

        fetch('/PhieuDatPhong/AddKhachHang', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify(khachHang)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var select = document.getElementById('khachHangSelect');
                select.add(new Option(`${data.khachHang.hoTen} (${data.khachHang.email})`, data.khachHang.khachHangId));
                select.value = data.khachHang.khachHangId;
                toastr.success('Thêm khách hàng thành công.');
                hideAddKhachHangForm();
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => toastr.error('Có lỗi xảy ra: ' + error.message));
    }

    function filterAvailableRooms() {
        var ngayNhan = document.getElementById('ngayNhan').value;
        var ngayTra = document.getElementById('ngayTra').value;
        var soLuongKhach = document.getElementById('soLuongKhach').value;

        if (!ngayNhan || !ngayTra) {
            toastr.error('Vui lòng nhập ngày nhận và ngày trả.');
            return;
        }

        var formData = new FormData();
        formData.append('ngayNhan', ngayNhan);
        formData.append('ngayTra', ngayTra);
        if (soLuongKhach) formData.append('soLuongKhach', soLuongKhach);

        fetch('/PhieuDatPhong/FilterEmptyRooms', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var select = document.getElementById('phongSelect');
                select.innerHTML = '';
                data.rooms.forEach(room => {
                    var option = new Option(
                        `Phòng ${room.soPhong} - ${room.loaiPhong || 'Không xác định'} - Giá: ${room.giaPhong1Dem?.toLocaleString() || '0'} VNĐ/ngày - ${room.soLuongKhach || '0'} khách`,
                        room.phongId
                    );
                    option.dataset.hinhanh = room.hinhAnh ? room.hinhAnh.replace('~/images/', '/images/') : FALLBACK_IMAGE;
                    option.dataset.hinhanh1 = room.hinhAnh1 ? room.hinhAnh1?.replace('~/images/', '/images/') : '';
                    option.dataset.hinhanh2 = room.hinhAnh2 ? room.hinhAnh2?.replace('~/images/', '/images/') : '';
                    option.dataset.hinhanh3 = room.hinhAnh3 ? room.hinhAnh3?.replace('~/images/', '/images/') : '';
                    option.dataset.sophong = room.soPhong;
                    option.dataset.loaiPhong = room.loaiPhong || 'Không xác định';
                    option.dataset.soluongkhach = room.soLuongKhach || '0';
                    option.dataset.dongia = room.giaPhong1Dem || '0';
                    select.appendChild(option);
                });
                updateRoomPreview();
                calculateTotal();
                toastr.success('Lọc phòng khả dụng thành công.');
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => {
            console.error('Lỗi khi lọc phòng:', error);
            toastr.error('Có lỗi xảy ra: ' + error.message);
        });
    }

    function calculateTotal() {
        var select = document.getElementById('phongSelect');
        var ngayNhan = document.getElementById('ngayNhan').value;
        var ngayTra = document.getElementById('ngayTra').value;
        var khuyenMaiSelect = document.getElementById('khuyenMaiSelect');
        var phanTramGiam = parseFloat(khuyenMaiSelect.selectedOptions[0]?.dataset.phantramgiam || 0);

        if (!ngayNhan || !ngayTra) {
            document.getElementById('tongTien').value = '0 VNĐ';
            return;
        }

        var soNgay = Math.max(1, Math.round((new Date(ngayTra) - new Date(ngayNhan)) / (1000 * 60 * 60 * 24)));
        var tongTien = 0;

        Array.from(select.selectedOptions).forEach(option => {
            var donGia = parseFloat(option.dataset.dongia || 0);
            tongTien += donGia * soNgay;
        });

        if (phanTramGiam > 0) {
            tongTien *= (1 - phanTramGiam / 100);
        }

        document.getElementById('tongTien').value = tongTien.toLocaleString('vi-VN') + ' VNĐ';
    }

    function updateRoomPreview() {
        var select = document.getElementById('phongSelect');
        var preview = document.getElementById('roomPreview');
        preview.innerHTML = '';
        Array.from(select.selectedOptions).forEach(option => {
            fetch(`/PhieuDatPhong/GetRoomDetails?phongId=${option.value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const room = data.room;
                        var images = [
                            room.hinhAnh ? room.hinhAnh.replace('~/images/', '/images/') : FALLBACK_IMAGE,
                            room.hinhAnh1 ? room.hinhAnh1.replace('~/images/', '/images/') : '',
                            room.hinhAnh2 ? room.hinhAnh2.replace('~/images/', '/images/') : '',
                            room.hinhAnh3 ? room.hinhAnh3.replace('~/images/', '/images/') : ''
                        ].filter(img => img);

                        var carouselId = `carousel-${option.value}`;
                        var carouselHtml = images.length > 1 ? `
                            <div id="${carouselId}" class="carousel slide" data-ride="carousel">
                                <div class="carousel-inner">
                                    ${images.map((img, index) => `
                                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                            <img src="${img}" class="d-block w-100" alt="Hình ảnh phòng" onerror="this.src='${FALLBACK_IMAGE}'">
                                        </div>
                                    `).join('')}
                                </div>
                                <a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </a>
                                <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </a>
                            </div>
                        ` : `<img src="${images[0]}" class="card-img-top" alt="Hình ảnh phòng" onerror="this.src='${FALLBACK_IMAGE}'">`;

                        var card = document.createElement('div');
                        card.className = 'col-md-4';
                        card.innerHTML = `
                            <div class="card">
                                <span class="remove-room badge badge-danger" onclick="removeRoom(${option.value})">X</span>
                                ${carouselHtml}
                                <div class="card-body">
                                    <h5 class="card-title">Phòng ${room.soPhong}</h5>
                                    <p class="card-text"><i class="fas fa-bed icon"></i> Loại phòng: ${room.loaiPhong || 'Không xác định'}</p>
                                    <p class="card-text"><i class="fas fa-users icon"></i> Số lượng khách: ${room.soLuongKhach}</p>
                                    <p class="card-text"><i class="fas fa-money-bill icon"></i> Giá/đêm: ${Number(room.giaPhong1Dem).toLocaleString()} VNĐ</p>
                                    <p class="card-text description"><i class="fas fa-info-circle icon"></i> Mô tả: ${room.moTa || 'Không có'}</p>
                                </div>
                            </div>
                        `;
                        preview.appendChild(card);
                    } else {
                        console.error(`Lỗi lấy chi tiết phòng ${option.value}:`, data.message);
                        toastr.error(`Không thể tải chi tiết phòng ${option.dataset.sophong}`);
                    }
                })
                .catch(error => {
                    console.error(`Lỗi khi lấy chi tiết phòng ${option.value}:`, error);
                    toastr.error('Có lỗi khi tải chi tiết phòng');
                });
        });
        calculateTotal();
    }

    function removeRoom(phongId) {
        var select = document.getElementById('phongSelect');
        var option = Array.from(select.options).find(o => o.value === phongId.toString());
        if (option) {
            option.selected = false;
        }
        updateRoomPreview();
    }

    document.getElementById('phongSelect').addEventListener('change', updateRoomPreview);
    document.getElementById('ngayNhan').addEventListener('change', calculateTotal);
    document.getElementById('ngayTra').addEventListener('change', calculateTotal);

    @if (TempData["Success"] != null)
    {
        @:toastr.success('@TempData["Success"]');
    }
    @if (TempData["Error"] != null)
    {
        @:toastr.error('@TempData["Error"]');
    }
</script>