@model Asp.netCoreDatPhongKS.Models.PhieuDatPhong
@{
    ViewData["Title"] = "Tạo phiếu đặt phòng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/PhieuDatPhongAdmin.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="container-fluid py-4">
    <h2 class="mb-4 text-primary fw-bold">Tạo phiếu đặt phòng</h2>

    <!-- Thông báo lỗi/success -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Form tạo phiếu đặt phòng -->
    <form asp-action="Create" asp-controller="PhieuDatPhong" method="post" id="phieuDatPhongForm" class="bg-light p-4 rounded shadow-sm">
        <div class="row g-3">
            <!-- Chọn khách hàng -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Khách hàng <span class="text-danger">*</span></label>
                <div class="input-group">
                    <select asp-for="KhachHangId" class="form-select" id="khachHangSelect" required>
                        <option value="">Chọn khách hàng</option>
                        @foreach (var khachHang in ViewBag.KhachHangs ?? new List<Asp.netCoreDatPhongKS.Models.KhachHang>())
                        {
                            <option value="@khachHang.KhachHangId">@khachHang.HoTen (@khachHang.Email - @khachHang.Cccd)</option>
                        }
                    </select>
                    <button type="button" class="btn btn-outline-primary" onclick="showAddKhachHangForm()">Thêm khách hàng mới</button>
                </div>
                <span asp-validation-for="KhachHangId" class="text-danger"></span>
            </div>

            <!-- Form thêm khách hàng mới -->
            <div id="addKhachHangForm" style="display:none;" class="col-12 mt-4 p-4 bg-white rounded shadow-sm">
                <h4 class="mb-3">Thêm khách hàng mới</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Họ tên <span class="text-danger">*</span></label>
                        <input type="text" id="newKhachHangHoTen" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                        <input type="email" id="newKhachHangEmail" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="text" id="newKhachHangSoDienThoai" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Địa chỉ <span class="text-danger">*</span></label>
                        <input type="text" id="newKhachHangDiaChi" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">CCCD <span class="text-danger">*</span></label>
                        <input type="text" id="newKhachHangCccd" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Ghi chú</label>
                        <textarea id="newKhachHangGhiChu" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-success me-2" onclick="addKhachHang()">Lưu khách hàng</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="hideAddKhachHangForm()">Hủy</button>
                    </div>
                </div>
            </div>
            <!-- Số lượng khách -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Số lượng khách/phòng</label>
                <input type="number" id="soLuongKhach" class="form-control" min="1" />
            </div>
            <!-- Ngày nhận phòng -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Ngày & giờ nhận phòng <span class="text-danger">*</span></label>
                <input asp-for="NgayNhan" type="datetime-local" class="form-control" id="ngayNhan" required
                       min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="NgayNhan" class="text-danger"></span>
            </div>

            <!-- Ngày trả phòng -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Ngày & giờ trả phòng <span class="text-danger">*</span></label>
                <input asp-for="NgayTra" type="datetime-local" class="form-control" id="ngayTra" required
                       min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="NgayTra" class="text-danger"></span>
            </div>

            <!-- Khuyến mãi -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Khuyến mãi</label>
                <select name="khuyenMaiId" class="form-select" id="khuyenMaiSelect" onchange="calculateTotal()">
                    <option value="">Không áp dụng khuyến mãi</option>
                    @foreach (var km in ViewBag.KhuyenMaiOptions ?? new List<SelectListItem>())
                    {
                        <option value="@km.Value" data-phantramgiam="@(km.Text.Contains("(") ? km.Text.Substring(km.Text.IndexOf("(") + 1, km.Text.IndexOf("%") - km.Text.IndexOf("(") - 1) : "0")">@km.Text</option>
                    }
                </select>
            </div>

            <!-- Tiền cọc -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Tiền cọc <span class="text-danger">*</span></label>
                <input type="number" name="soTienCoc" class="form-control" value="0" required />
            </div>

            <!-- Số tiền đã thanh toán -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Số tiền đã thanh toán (nếu có)</label>
                <input type="number" name="soTienDaThanhToan" class="form-control" value="0" required />
            </div>

            <!-- Tổng tiền -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Tổng tiền (sau khuyến mãi)</label>
                <input type="text" id="tongTien" class="form-control" readonly />
            </div>

            <!-- Trạng thái -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Trạng thái <span class="text-danger">*</span></label>
                <select name="trangThai" class="form-select" required>
                    <option value="">Chọn trạng thái</option>
                    @foreach (var item in ViewBag.TrangThaiOptions)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>

            <!-- Tình trạng sử dụng -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Tình trạng sử dụng <span class="text-danger">*</span></label>
                <select name="tinhTrangSuDung" class="form-select" required>
                    <option value="">Chọn tình trạng</option>
                    @foreach (var item in ViewBag.TinhTrangSuDungOptions)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>

            <!-- Chọn phòng -->
            <div class="col-12">
                <label class="form-label fw-semibold">Chọn phòng <span class="text-danger">*</span></label>
                <div class="input-group">
                    <select name="phongIds" multiple class="form-select" required id="phongSelect" style="height: 200px !important;">
                        @foreach (var phong in ViewBag.Phongs ?? new List<Asp.netCoreDatPhongKS.Models.Phong>())
                        {
                            <option value="@phong.PhongId"
                                    data-hinhanh="@(phong.HinhAnh != null ? phong.HinhAnh.Replace("~/images/", "/images/") : "/images/no-image.jpg")"
                                    data-hinhanh1="@(phong.HinhAnh1 != null ? phong.HinhAnh1.Replace("~/images/", "/images/") : "")"
                                    data-hinhanh2="@(phong.HinhAnh2 != null ? phong.HinhAnh2.Replace("~/images/", "/images/") : "")"
                                    data-hinhanh3="@(phong.HinhAnh3 != null ? phong.HinhAnh3.Replace("~/images/", "/images/") : "")"
                                    data-sophong="@phong.SoPhong"
                                    data-loaiPhong="@(phong.LoaiPhong?.TenLoai ?? "Không xác định")"
                                    data-soluongkhach="@phong.SoLuongKhach"
                                    data-dongia="@phong.GiaPhong1Dem">
                                Phòng @phong.SoPhong - @(phong.LoaiPhong?.TenLoai ?? "Không") - Giá: @phong.GiaPhong1Dem?.ToString("N0") VNĐ/ngày - @phong.SoLuongKhach khách
                            </option>
                        }
                    </select>
                    <button type="button" class="btn btn-outline-info" onclick="filterAvailableRooms()">Lọc phòng khả dụng</button>
                </div>
            </div>

            <!-- Xem trước phòng -->
            <div id="roomPreview" class="row g-3 mt-3"></div>

            <!-- Nút điều khiển -->
            <div class="col-12 mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-success">Tạo phiếu</button>
                <a href="@Url.Action("Index", "PhieuDatPhong")" class="btn btn-outline-secondary">Quay lại</a>
            </div>
        </div>
    </form>
</div>

<style>
    #roomPreview .card {
        margin-bottom: 15px;
        transition: transform 0.2s;
        position: relative;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

        #roomPreview .card:hover {
            transform: translateY(-5px);
        }

    #roomPreview .card-img-top {
        height: 200px;
        object-fit: cover;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
    }

    #roomPreview .carousel-inner img {
        height: 200px;
        object-fit: cover;
    }

    #roomPreview .remove-room {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        z-index: 3;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    #roomPreview .card-text.description {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #roomPreview .icon {
        margin-right: 5px;
        color: #007bff;
    }

    #phieuDatPhongForm .form-control, #phieuDatPhongForm .form-select {
        border-radius: 0.375rem;
    }

    .input-group .btn {
        border-radius: 0.375rem;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

<script>
    const FALLBACK_IMAGE = '/images/no-image.jpg';

    function showAddKhachHangForm() {
        $('#addKhachHangForm').slideDown();
    }

    function hideAddKhachHangForm() {
        $('#addKhachHangForm').slideUp();
    }

    function addKhachHang() {
        var khachHang = {
            HoTen: $('#newKhachHangHoTen').val(),
            Email: $('#newKhachHangEmail').val(),
            SoDienThoai: $('#newKhachHangSoDienThoai').val(),
            DiaChi: $('#newKhachHangDiaChi').val(),
            Cccd: $('#newKhachHangCccd').val(),
            GhiChu: $('#newKhachHangGhiChu').val()
        };

        if (!khachHang.HoTen || !khachHang.Email || !khachHang.SoDienThoai || !khachHang.DiaChi || !khachHang.Cccd) {
            toastr.error('Vui lòng nhập đầy đủ thông tin.');
            return;
        }

        $.ajax({
            url: '/PhieuDatPhong/AddKhachHang',
            method: 'POST',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify(khachHang),
            contentType: 'application/json',
            success: function (data) {
                if (data.success) {
                    var select = $('#khachHangSelect');
                    select.append(new Option(`${data.khachHang.hoTen} (${data.khachHang.email})`, data.khachHang.khachHangId));
                    select.val(data.khachHang.khachHangId);
                    toastr.success('Thêm khách hàng thành công.');
                    hideAddKhachHangForm();
                } else {
                    toastr.error(data.message);
                }
            },
            error: function (error) {
                toastr.error('Có lỗi xảy ra: ' + error.responseText);
            }
        });
    }

    function filterAvailableRooms() {
        var ngayNhan = $('#ngayNhan').val();
        var ngayTra = $('#ngayTra').val();
        var soLuongKhach = $('#soLuongKhach').val();

        if (!ngayNhan || !ngayTra) {
            toastr.error('Vui lòng nhập ngày nhận và ngày trả.');
            return;
        }

        var formData = new FormData();
        formData.append('ngayNhan', ngayNhan);
        formData.append('ngayTra', ngayTra);
        if (soLuongKhach) formData.append('soLuongKhach', soLuongKhach);

        $.ajax({
            url: '/PhieuDatPhong/FilterEmptyRooms',
            method: 'POST',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data.success) {
                    var select = $('#phongSelect');
                    select.empty();
                    data.rooms.forEach(room => {
                        var option = new Option(
                            `Phòng ${room.soPhong} - ${room.loaiPhong || 'Không xác định'} - Giá: ${room.giaPhong1Dem?.toLocaleString() || '0'} VNĐ/ngày - ${room.soLuongKhach || '0'} khách`,
                            room.phongId
                        );
                        option.dataset.hinhanh = room.hinhAnh ? room.hinhAnh.replace('~/images/', '/images/') : FALLBACK_IMAGE;
                        option.dataset.hinhanh1 = room.hinhAnh1 ? room.hinhAnh1.replace('~/images/', '/images/') : '';
                        option.dataset.hinhanh2 = room.hinhAnh2 ? room.hinhAnh2.replace('~/images/', '/images/') : '';
                        option.dataset.hinhanh3 = room.hinhAnh3 ? room.hinhAnh3.replace('~/images/', '/images/') : '';
                        option.dataset.sophong = room.soPhong;
                        option.dataset.loaiPhong = room.loaiPhong || 'Không xác định';
                        option.dataset.soluongkhach = room.soLuongKhach || '0';
                        option.dataset.dongia = room.giaPhong1Dem || '0';
                        select.append(option);
                    });
                    updateRoomPreview();
                    calculateTotal();
                    toastr.success('Lọc phòng khả dụng thành công.');
                } else {
                    toastr.error(data.message);
                }
            },
            error: function (error) {
                toastr.error('Có lỗi xảy ra: ' + error.responseText);
            }
        });
    }

    function calculateTotal() {
        var select = $('#phongSelect');
        var ngayNhan = $('#ngayNhan').val();
        var ngayTra = $('#ngayTra').val();
        var khuyenMaiSelect = $('#khuyenMaiSelect');
        var phanTramGiam = parseFloat(khuyenMaiSelect.find('option:selected').data('phantramgiam') || 0);

        if (!ngayNhan || !ngayTra) {
            $('#tongTien').val('0 VNĐ');
            return;
        }

        var soNgay = Math.max(1, Math.round((new Date(ngayTra) - new Date(ngayNhan)) / (1000 * 60 * 60 * 24)));
        var tongTien = 0;

        select.find('option:selected').each(function () {
            var donGia = parseFloat($(this).data('dongia') || 0);
            tongTien += donGia * soNgay;
        });

        if (phanTramGiam > 0) {
            tongTien *= (1 - phanTramGiam / 100);
        }

        $('#tongTien').val(tongTien.toLocaleString('vi-VN') + ' VNĐ');
    }

    function updateRoomPreview() {
        var select = $('#phongSelect');
        var preview = $('#roomPreview');
        preview.empty(); // Xóa sạch nội dung để tránh trùng lặp

        // Tạo một Set để theo dõi các phòng đã được thêm
        var addedRooms = new Set();

        select.find('option:selected').each(function () {
            var option = $(this);
            var phongId = option.val();

            // Chỉ xử lý nếu phòng chưa được thêm
            if (!addedRooms.has(phongId)) {
                addedRooms.add(phongId);

                $.ajax({
                    url: `/PhieuDatPhong/GetRoomDetails?phongId=${phongId}`,
                    method: 'GET',
                    success: function (data) {
                        if (data.success) {
                            const room = data.room;
                            var images = [
                                room.hinhAnh ? room.hinhAnh.replace('~/images/', '/images/') : FALLBACK_IMAGE,
                                room.hinhAnh1 ? room.hinhAnh1.replace('~/images/', '/images/') : '',
                                room.hinhAnh2 ? room.hinhAnh2.replace('~/images/', '/images/') : '',
                                room.hinhAnh3 ? room.hinhAnh3.replace('~/images/', '/images/') : ''
                            ].filter(img => img);

                            var carouselId = `carousel-${phongId}`;
                            var carouselHtml = images.length > 1 ? `
                                <div id="${carouselId}" class="carousel slide">
                                    <div class="carousel-inner">
                                        ${images.map((img, index) => `
                                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                                <img src="${img}" class="d-block w-100" alt="Hình ảnh phòng" onerror="this.src='${FALLBACK_IMAGE}'">
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    </button>
                                </div>
                            ` : `<img src="${images[0]}" class="card-img-top" alt="Hình ảnh phòng" onerror="this.src='${FALLBACK_IMAGE}'">`;

                            var card = `
                                <div class="col-md-4">
                                    <div class="card">
                                        <span class="remove-room" onclick="removeRoom(${phongId})">X</span>
                                        ${carouselHtml}
                                        <div class="card-body">
                                            <h5 class="card-title">Phòng ${room.soPhong}</h5>
                                            <p class="card-text"><i class="fas fa-bed icon"></i> Loại phòng: ${room.loaiPhong || 'Không xác định'}</p>
                                            <p class="card-text"><i class="fas fa-users icon"></i> Số lượng khách: ${room.soLuongKhach}</p>
                                            <p class="card-text"><i class="fas fa-money-bill icon"></i> Giá/đêm: ${Number(room.giaPhong1Dem).toLocaleString()} VNĐ</p>
                                            <p class="card-text description"><i class="fas fa-info-circle icon"></i> Mô tả: ${room.moTa || 'Không có'}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            preview.append(card);
                        } else {
                            toastr.error(`Không thể tải chi tiết phòng ${option.data('sophong')}`);
                        }
                    },
                    error: function (error) {
                        toastr.error('Có lỗi khi tải chi tiết phòng');
                    }
                });
            }
        });

        calculateTotal();
    }

    function removeRoom(phongId) {
        var select = $('#phongSelect');
        select.find(`option[value="${phongId}"]`).prop('selected', false);
        updateRoomPreview();
    }

    $(document).ready(function () {
        $('#phongSelect').on('change', function () {
            updateRoomPreview();
        });
        $('#ngayNhan, #ngayTra').on('change', calculateTotal);

        @if (TempData["Success"] != null)
        {
                @:toastr.success('@TempData["Success"]');
        }
        @if (TempData["Error"] != null)
        {
                @:toastr.error('@TempData["Error"]');
        }
    });
</script>