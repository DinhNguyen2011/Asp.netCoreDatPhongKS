@model IEnumerable<Asp.netCoreDatPhongKS.Models.ViewModels.HoaDonViewModel>
@{
    ViewData["Title"] = "Quản lý hóa đơn";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/hoadontong.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="container-fluid py-4">
    <h2 class="mb-4 text-primary fw-bold">Quản lý hóa đơn</h2>
    <!-- <p class="mb-4 text-muted">Nhân viên: @ViewData["Hoten"]</p> -->
    <!-- Form tìm kiếm và bộ lọc -->
    <form asp-action="Index" method="get" class="mb-4 bg-light p-3 rounded shadow-sm">
        <div class="input-group">
            <input type="text" name="searchString" class="form-control" placeholder="Nhập Tên hoặc CCCD để tìm" value="@ViewData["CurrentFilter"]" />
            <select name="trangThai" class="form-select ms-2">
                <option value="Tất cả" selected="@(ViewData["CurrentTrangThai"] == "Tất cả")">Tất cả</option>
                <option value="Chưa thanh toán" selected="@(ViewData["CurrentTrangThai"] == "Chưa thanh toán")">Chưa thanh toán</option>
                <option value="Đã thanh toán" selected="@(ViewData["CurrentTrangThai"] == "Đã thanh toán")">Đã thanh toán</option>
            </select>
            <button type="submit" class="btn btn-primary ms-2">Tìm kiếm</button>
        </div>
    </form>

    <a asp-action="CreateHoaDonTong" class="btn btn-success mb-4">Tạo hóa đơn tổng (Check-out)</a>

    <!-- Danh sách hóa đơn -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Khách hàng</th>
                    <th>CCCD</th>
                    <th>Tổng tiền</th>
                    <th>Hình thức</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">Không có hóa đơn nào.</td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.KhachHangTen</td>
                            <td>@item.KhachHangCCCD</td>
                            <td>@item.TongTien.ToString("N0") VNĐ</td>
                            <td>@(item.HoaDon?.HinhThucThanhToan ?? "Chưa xác định")</td>
                            <td>@item.TrangThai</td>
                            <td>
                                <button class="btn btn-info btn-sm toggle-details" data-id="@item.Id" title="Xem chi tiết">
                                    <i class="fa fa-eye"></i>
                                </button>
                                @if (item.HoaDon != null)
                                {
                                    <a asp-action="PrintHoaDonTong" asp-route-id="@item.Id" class="btn btn-success btn-sm ms-1" target="_blank" title="In hóa đơn">
                                        <i class="fa fa-print"></i>
                                    </a>
                                }
                            </td>
                        </tr>
                        <tr class="hoa-don-details" id="details_@item.Id" style="display:none;">
                            <td colspan="6">
                                <div class="p-3 bg-light rounded shadow-sm">
                                    @if (item.HoaDon != null && item.HoaDon.HoaDonDichVus.Any())
                                    {
                                        <h6 class="mb-2"><i class="fas fa-receipt me-1"></i> Dịch vụ</h6>
                                        <table class="table table-sm table-bordered mb-3">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Tên dịch vụ</th>
                                                    <th>Số lượng</th>
                                                    <th>Đơn giá</th>
                                                    <th>Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int stt = 1;
                                                    foreach (var hdv in item.HoaDon.HoaDonDichVus)
                                                    {
                                                        foreach (var chiTiet in hdv.MaDonHangDvNavigation.ChiTietDonHangDichVus)
                                                        {
                                                            <tr>
                                                                <td>@stt</td>
                                                                <td>@chiTiet.DichVu.TenDichVu</td>
                                                                <td>@chiTiet.SoLuong</td>
                                                                <td>@chiTiet.DonGia.ToString("N0") VNĐ</td>
                                                                <td>@chiTiet.ThanhTien?.ToString("N0") VNĐ</td>
                                                            </tr>
                                                            stt++;
                                                        }
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    }
                                    @if (item.HoaDon != null && item.HoaDon.HoaDonPdps.Any())
                                    {
                                        <h6 class="mb-2"><i class="fas fa-bed me-1"></i> Phòng</h6>
                                        <table class="table table-sm table-bordered mb-3">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Mã phiếu</th>
                                                    <th>Phòng</th>
                                                    <th>Loại phòng</th>
                                                    <th>Số ngày ở</th>
                                                    <th>Tiền/Ngày</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tiền cọc</th>
                                                    <th>Đã thanh toán</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int sttP = 1;
                                                    foreach (var hdp in item.HoaDon.HoaDonPdps)
                                                    {
                                                        var chiTietP = hdp.PhieuDatPhong.ChiTietPhieuPhongs.FirstOrDefault();
                                                        if (chiTietP != null)
                                                        {
                                                            var soNgayO = ((hdp.PhieuDatPhong.NgayTra ?? DateTime.Now) - (hdp.PhieuDatPhong.NgayNhan ?? DateTime.Now)).Days;
                                                            soNgayO = soNgayO < 1 ? 1 : soNgayO;

                                                            <tr>
                                                                <td>@sttP</td>
                                                                <td>@hdp.PhieuDatPhong.MaPhieu</td>
                                                                <td>@chiTietP.Phong.SoPhong</td>
                                                                <td>@(chiTietP.Phong.LoaiPhong?.TenLoai ?? "Không xác định")</td>
                                                                <td>@soNgayO ngày</td>
                                                                <td>@chiTietP.DonGia?.ToString("N0") VNĐ</td>
                                                                <td>@hdp.PhieuDatPhong.TongTien.ToString("N0") VNĐ</td>
                                                                <td>@hdp.PhieuDatPhong.SoTienCoc?.ToString("N0") VNĐ</td>
                                                                <td>@hdp.PhieuDatPhong.SoTienDaThanhToan?.ToString("N0") VNĐ</td>
                                                            </tr>
                                                            sttP++;
                                                        }
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    }
                                    @if (item.HoaDonDichVu != null)
                                    {
                                        <h6 class="mb-2"><i class="fas fa-receipt me-1"></i> Dịch vụ (vãng lai)</h6>
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Tên dịch vụ</th>
                                                    <th>Số lượng</th>
                                                    <th>Đơn giá</th>
                                                    <th>Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int stt = 1;
                                                    foreach (var chiTiet in item.HoaDonDichVu.MaDonHangDvNavigation.ChiTietDonHangDichVus)
                                                    {
                                                        <tr>
                                                            <td>@stt</td>
                                                            <td>@chiTiet.DichVu.TenDichVu</td>
                                                            <td>@chiTiet.SoLuong</td>
                                                            <td>@chiTiet.DonGia.ToString("N0") VNĐ</td>
                                                            <td>@chiTiet.ThanhTien?.ToString("N0") VNĐ</td>
                                                        </tr>
                                                        stt++;
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('.toggle-details').click(function () {
            var id = $(this).data('id');
            $('#details_' + id).slideToggle(300); // Hiệu ứng mượt mà khi hiển thị/ẩn
            $(this).find('i').toggleClass('fa-eye fa-eye-slash'); // Chuyển đổi icon khi mở/đóng
        });

        // Thêm hiệu ứng hover cho nút toggle-details
        $('.toggle-details').hover(
            function () {
                $(this).addClass('shadow-sm');
            },
            function () {
                $(this).removeClass('shadow-sm');
            }
        );
    });
</script>

<style>
    .hoa-don-details {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .toggle-details {
        transition: all 0.3s ease;
    }

    .table-sm th, .table-sm td {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
</style>