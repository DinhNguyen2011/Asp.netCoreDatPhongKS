@model Asp.netCoreDatPhongKS.Models.HoaDon
@{
    ViewData["Title"] = "Hóa đơn tổng hợp";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    decimal tongTienDichVu = Model.HoaDonDichVus?.Sum(h => h.MaDonHangDvNavigation.ChiTietDonHangDichVus.Sum(c => c.ThanhTien ?? 0)) ?? 0;
 //   decimal tongTienPhong = Model.HoaDonPdps.Sum(h => h.PhieuDatPhong.ChiTietPhieuPhongs.Sum(c => c.DonGia ?? 0)) ?? 0;
}

<link rel="stylesheet" href="~/assets/css/hoadondichvu.css" />

<div class="invoice">
    <div class="invoice-header">
        <h2>HÓA ĐƠN TỔNG HỢP</h2>
        <p>Khách sạn THIỀM ĐỊNH</p>
        <p>Ngày lập: @Model.NgayLap?.ToString("dd/MM/yyyy HH:mm")</p>
    </div>

    <div class="invoice-details">
        <p><strong>Khách hàng:</strong> @Model.KhachHang.HoTen</p>
        <p><strong>Nhân viên lập:</strong> @ViewData["Hoten"]</p>
        <p><strong>Hình thức thanh toán:</strong> @Model.HinhThucThanhToan</p>
        <p><strong>Trạng thái:</strong> @Model.TrangThai</p>
    </div>

    <!-- Chi tiết dịch vụ -->
    @if (Model.HoaDonDichVus.Any())
    {
            <h5>Chi tiết dịch vụ</h5>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên dịch vụ</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                @{
                    int stt = 1;
                    foreach (var hdv in Model.HoaDonDichVus)
                    {
                        foreach (var chiTiet in hdv.MaDonHangDvNavigation.ChiTietDonHangDichVus)
                        {
                                            <tr>
                                                <td>@stt</td>
                                                <td>@chiTiet.DichVu.TenDichVu</td>
                                                <td>@chiTiet.SoLuong</td>
                                                <td>@chiTiet.DonGia.ToString("N0") VNĐ</td>
                                                <td>@chiTiet.ThanhTien?.ToString("N0") VNĐ</td>
                                            </tr>
                            stt++;
                        }
                    }
                }
                    <tr>
                        <td colspan="4" class="text-end"><strong>Tổng tiền dịch vụ:</strong></td>
                        <td><strong>@tongTienDichVu.ToString("N0") VNĐ</strong></td>
                    </tr>
                </tbody>
            </table>
    }

    <!-- Chi tiết phòng -->
    @if (Model.HoaDonPdps.Any())
    {
            <h5>Chi tiết phòng</h5>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Mã phiếu</th>
                        <th>Phòng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                @{
                    int sttP = 1;
                    foreach (var hdp in Model.HoaDonPdps)
                    {
                        var chiTiet = hdp.PhieuDatPhong.ChiTietPhieuPhongs.FirstOrDefault();
                        if (chiTiet != null)
                        {
                                            <tr>
                                                <td>@sttP</td>
                                                <td>@hdp.PhieuDatPhong.MaPhieu</td>
                                                <td>@chiTiet.Phong.SoPhong</td>
                                                <td>@chiTiet.DonGia?.ToString("N0") VNĐ</td>
                                                <td>@chiTiet.DonGia?.ToString("N0") VNĐ</td>
                                            </tr>
                            sttP++;
                        }
                    }
                }
                    <tr>
                        <td colspan="4" class="text-end"><strong>Tổng tiền phòng:</strong></td>
                       @*  <td><strong>@tongTienPhong.ToString("N0") VNĐ</strong></td> *@
                    </tr>
                </tbody>
            </table>
    }

    <div class="invoice-total">
        <p><strong>Tổng cộng:</strong> @Model.TongTien?.ToString("N0") VNĐ</p>
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <p>Khách hàng</p>
            <p>(Ký và ghi rõ họ tên)</p>
        </div>
        <div class="signature-box">
            <p>Nhân viên lập hóa đơn</p>
            <p>(Ký và ghi rõ họ tên)</p>
        </div>
    </div>

    <div class="invoice-footer no-print">
        <button onclick="window.print()" class="btn btn-primary">In hóa đơn</button>
        <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>
</div>