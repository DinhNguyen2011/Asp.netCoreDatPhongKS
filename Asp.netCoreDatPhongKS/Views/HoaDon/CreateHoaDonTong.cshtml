@model Asp.netCoreDatPhongKS.Models.HoaDon
@{
    ViewData["Title"] = "Tạo hóa đơn tổng (Check-out)";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var khachHangs = ViewBag.KhachHangs as List<Asp.netCoreDatPhongKS.Models.KhachHang>;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/hoadontong.css" rel="stylesheet" />

<div class="container-fluid py-4">
    <h2 class="mb-4 text-primary fw-bold">Tạo hóa đơn tổng (Check-out)</h2>
    <p class="mb-4 text-muted">Nhân viên: @ViewData["Hoten"]</p>

    <!-- Form tìm kiếm khách hàng -->
    <form asp-action="CreateHoaDonTong" method="get" class="mb-4 bg-light p-3 rounded shadow-sm">
        <div class="input-group">
            <input type="text" name="searchKhachHang" class="form-control" placeholder="Tìm kiếm tên hoặc CCCD khách hàng..." value="@ViewBag.SearchKhachHang" />
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </div>
    </form>

    <!-- Form tạo hóa đơn tổng -->
    <form asp-action="CreateHoaDonTong" method="post" class="container mt-4 bg-light p-4 rounded shadow-sm">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <!-- Danh sách khách hàng -->
        <div class="form-group mb-4">
            <label class="form-label fw-semibold">Chọn khách hàng <span class="text-danger">*</span></label>
            <select name="khachHangId" id="khachHangId" class="form-select" required>
                <option value="">Chọn khách hàng</option>
                @foreach (var khachHang in khachHangs)
                {
                    <option value="@khachHang.KhachHangId">@khachHang.HoTen (@khachHang.Cccd)</option>
                }
            </select>
        </div>

        <!-- Hóa đơn dịch vụ chưa thanh toán -->
        <div class="form-group mb-4" id="hoaDonDichVuList">
            <h5 class="mb-3 fw-bold text-primary">Hóa đơn dịch vụ chưa thanh toán</h5>
            <div id="hoaDonDichVuContainer" class="border p-3 rounded bg-white"></div>
        </div>

        <!-- Phiếu đặt phòng chưa thanh toán -->
        <div class="form-group mb-4" id="phieuDatPhongList">
            <h5 class="mb-3 fw-bold text-primary">Phiếu đặt phòng chưa thanh toán</h5>
            <div id="phieuDatPhongContainer" class="border p-3 rounded bg-white"></div>
        </div>

        <!-- Hình thức thanh toán -->
        <div class="form-group mb-4">
            <label class="form-label fw-semibold">Hình thức thanh toán <span class="text-danger">*</span></label>
            <select name="hinhThucThanhToan" class="form-select" required>
                <option value="">Chọn hình thức</option>
                <option value="Tiền mặt">Tiền mặt</option>
                <option value="Chuyển khoản">Chuyển khoản</option>
                <option value="VNPay">VNPay</option>
                <option value="MoMo">MoMo</option>
            </select>
        </div>

        <!-- Nút submit -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Tạo hóa đơn tổng</button>
            <a asp-action="Index" class="btn btn-outline-secondary ms-2">Quay lại</a>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#khachHangId').change(function () {
            var khachHangId = $(this).val();
            if (khachHangId) {
                // Lấy danh sách hóa đơn dịch vụ
                $.get('/HoaDon/GetHoaDonDichVu?khachHangId=' + khachHangId, function (data) {
                    $('#hoaDonDichVuContainer').empty();
                    if (data.length > 0) {
                        data.forEach(function (hdv) {
                        // Tạo HTML cho danh sách dịch vụ
                        let dichVuList = '<ul>';
                        hdv.tendichvu.forEach(function (dv) {
                            dichVuList += `<li>${dv.tendv}: ${dv.giaDV.toLocaleString('vi-VN')} VNĐ</li>`;
                        });
                        dichVuList += '</ul>';

                        $('#hoaDonDichVuContainer').append(
                            '<div class="form-check">' +
                            '<input type="checkbox" name="hoaDonDichVuIds" value="' + hdv.id + '" class="form-check-input" id="hdv_' + hdv.id + '">' +
                            '<label class="form-check-label" for="hdv_' + hdv.id + '">' +
                            'Mã đơn hàng: #' + hdv.maDonHangDv + '<br>' +
                            'Tổng tiền: ' + hdv.tongTien.toLocaleString('vi-VN') + ' VNĐ' +
                            '<br>Dịch vụ:<br>' + dichVuList +
                            '</label></div>'
                            );
                        });
                    } else {
                        $('#hoaDonDichVuContainer').append('<p class="text-muted">Không có hóa đơn dịch vụ chưa thanh toán.</p>');
                    }
                });

                // Lấy danh sách phiếu đặt phòng
                $.get('/HoaDon/GetPhieuDatPhong?khachHangId=' + khachHangId, function (data) {
                    $('#phieuDatPhongContainer').empty();
                    if (data.length > 0) {
                        data.forEach(function (phieu) {
                              const ngayNhan = new Date(phieu.ngaynhanphong);
    const formattedDate = ngayNhan.toLocaleDateString('vi-VN'); // dd/MM/yyyy

                            $('#phieuDatPhongContainer').append(
                                '<div class="form-check">' +
                                '<input type="checkbox" name="phieuDatPhongIds" value="' + phieu.phieuDatPhongId + '" class="form-check-input" id="phieu_' + phieu.phieuDatPhongId + '">' +
                                   '<label class="form-check-label" for="phieu_' + phieu.phieuDatPhongId + '">' +
                                  'Mã phiếu: ' + phieu.maPhieu + '<br>' +
                                 'Phòng: ' + phieu.soPhong + '<br>' +
                                 'Ngày nhận phòng: ' + formattedDate + '<br>' +
                                 'Tổng tiền: ' + phieu.tongsotien.toLocaleString('vi-VN') + ' VNĐ' +
                                 '</label></div>'
                            );
                        });
                    } else {
                        $('#phieuDatPhongContainer').append('<p class="text-muted">Không có phiếu đặt phòng chưa thanh toán.</p>');
                    }
                });
            } else {
                $('#hoaDonDichVuContainer').empty();
                $('#phieuDatPhongContainer').empty();
            }
        });
    });
</script>